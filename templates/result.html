<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Result • Mental Health Detection</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="{{ url_for('static', filename='css/styles.css') }}" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
<nav class="navbar navbar-dark bg-dark">
  <div class="container d-flex justify-content-between">
    <a class="navbar-brand" href="#">Mental Health Detection</a>
    <div>
      <span class="me-3">Hi, <strong id="username">{{ username }}</strong></span>
      <a class="btn btn-outline-light btn-sm" href="{{ url_for('logout') }}">Logout</a>
    </div>
  </div>
</nav>

<div class="container py-5">
  <div class="row g-4">
    <div class="col-lg-7">
      <div class="card p-4 h-100">
        <h3 class="mb-3">Your Result</h3>
        <p class="mb-1">Mental health status:</p>
        <h4 id="statusBadge"></h4>

        <p class="mt-3">Stress score: <strong id="stressScore"></strong></p>

        <div class="mt-3">
          <h5>Recommendations</h5>
          <ul id="recommendations"></ul>
        </div>

        <!-- ✅ Booking form -->
        <form class="mt-4" action="{{ url_for('book') }}" method="POST">
          <!-- hidden field to send predicted status -->
          <input type="hidden" name="predicted_status" id="predictedStatusInput">

          <div class="row g-3 align-items-end">
            <div class="col-md-4">
              <label class="form-label">Specialist</label>
              <select class="form-select" name="specialist" required>
                <option value="Psychiatrist">Psychiatrist</option>
                <option value="Clinical Psychologist">Clinical Psychologist</option>
                <option value="Therapist / Counselor">Therapist / Counselor</option>
                <option value="Family Physician">Family Physician</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Date</label>
              <input class="form-control" type="date" name="appt_date" required>
            </div>
            <div class="col-md-3">
              <label class="form-label">Time</label>
              <input class="form-control" type="time" name="appt_time" required>
            </div>
            <div class="col-md-12">
              <button class="btn btn-primary" type="submit">Book Appointment</button>
            </div>
          </div>
        </form>
        <!-- ✅ End Booking form -->

      </div>
    </div>

    <div class="col-lg-5">
      <div class="card p-4 mb-4">
        <h5 class="mb-3">Mental Stress vs Normal (Pie)</h5>
        <canvas id="pieChart" height="260"></canvas>
      </div>

      <div class="card p-4 mb-4">
        <h5 class="mb-3">Stress Trend (Line)</h5>
        <canvas id="lineChart" height="260"></canvas>
      </div>

      <div class="card p-4">
        <h5 class="mb-3">Model Accuracy</h5>
        <p><strong>Model Accuracy: 80% - 90%</strong></p>
      </div>
    </div>
  </div>
</div>

<footer class="py-4 text-center">© 2025 Mental Health Detection</footer>

<script>
  // Fetch data from API
  fetch('/api/result-data')
    .then(response => response.json())
    .then(data => {
      // Use the data to populate the page
      document.getElementById("stressScore").textContent = data.stress_score + "%";
      document.getElementById("predictedStatusInput").value = data.overall_status;
      
      const statusBadge = document.getElementById("statusBadge");
      if (data.overall_status === "Needs Medical Guidance") {
        statusBadge.innerHTML = '<span class="badge text-bg-danger">Needs Medical Guidance</span>';
      } else {
        statusBadge.innerHTML = '<span class="badge text-bg-success">Healthy</span>';
      }
      
      const recList = document.getElementById("recommendations");
      recList.innerHTML = data.recommendations.map(r => `<li>${r}</li>`).join("");
      
      // Convert percentage values for pie chart
      const pieValues = data.pie_values.map(value => value * 100);
      
      // === Pie chart ===
      const ctxPie = document.getElementById('pieChart');
      if (ctxPie) {
        new Chart(ctxPie, {
          type: 'pie',
          data: {
            labels: data.pie_labels,
            datasets: [{
              data: pieValues,
              backgroundColor: ['#dc3545', '#28a745']
            }]
          }
        });
      }

      // === Line chart ===
      const ctxLine = document.getElementById('lineChart');
      if (ctxLine) {
        new Chart(ctxLine, {
          type: 'line',
          data: {
            labels: data.history_labels,
            datasets: [{
              label: 'Stress Trend',
              data: data.history_values,
              borderColor: '#198754',
              backgroundColor: 'rgba(25, 135, 84, 0.2)',
              fill: true,
              tension: 0.3
            }]
          },
          options: {
            scales: {
              y: {
                beginAtZero: true,
                max: 100
              }
            }
          }
        });
      }
    })
    .catch(error => {
      console.error('Error fetching result data:', error);
      // Fallback to default values if API fails
      document.getElementById("stressScore").textContent = "0%";
      document.getElementById("statusBadge").innerHTML = '<span class="badge text-bg-secondary">Unknown</span>';
      document.getElementById("recommendations").innerHTML = '<li>Unable to load recommendations</li>';
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>